# Story 2.1: Cleanup Test Artifacts & Duplicates

## Status
In Progress - 95% Complete (Blocked on Python 3.9 compatibility)

## Story
**As a** developer,
**I want** the codebase cleaned of test artifacts and duplicate files,
**so that** the repository is organized, maintainable, and follows best practices.

## Acceptance Criteria
1. [x] All duplicate " 2.md" files removed (keep most recent version)
2. [x] Test artifacts and temporary files cleaned from test directories
3. [x] Old test reports archived to `/tests/archive/`
4. [x] Python cache directories (`__pycache__`, `.pytest_cache`) removed
5. [x] .gitignore updated with comprehensive artifact patterns
6. [x] Cleanup script created in `/scripts/maintenance/`
7. [x] Test documentation updated to reflect current structure
8. [ ] All tests still pass after cleanup **[BLOCKED - Python 3.9 compatibility issues]**

## Tasks / Subtasks
- [x] Task 1: Find and remove duplicate files (AC: 1)
  - [x] Run `find . -name "*' 2.*'" -type f` to locate all duplicates
  - [x] For each duplicate pair, diff to determine most recent version
  - [x] Update any references to renamed files
  - [x] Remove older duplicate versions
  - [x] Verify no broken imports or references

- [x] Task 2: Clean Python artifacts (AC: 4, 5)
  - [x] Remove all `__pycache__` directories: `find . -type d -name "__pycache__" -exec rm -rf {} +`
  - [x] Remove all `.pytest_cache` directories: `find . -type d -name ".pytest_cache" -exec rm -rf {} +`
  - [x] Remove `.coverage` files and `htmlcov` directories
  - [x] Add patterns to .gitignore: `__pycache__/`, `.pytest_cache/`, `.coverage`, `htmlcov/`

- [x] Task 3: Archive old test reports (AC: 3)
  - [x] Create archive structure: `mkdir -p tests/archive/coverage tests/archive/reports`
  - [x] Move old coverage reports: `mv tests/coverage/coverage-*.json tests/archive/coverage/`
  - [x] Move test result JSON files from `tests/test_results/`
  - [x] Archive single report from `tests/reports/`
  - [x] Document archive structure in tests/README.md

- [x] Task 4: Clean test fixtures and unused files (AC: 2)
  - [x] Review `/tests/fixtures/` for unused mock data
  - [x] Remove temporary test databases
  - [x] Clean up any `.db` or `.sqlite` files in tests directory
  - [x] Remove broken test scripts (`test_ai_babysitter.sh`, `view_test_history.sh`)

- [x] Task 5: Create maintenance script (AC: 6)
  - [x] Create `/scripts/maintenance/cleanup_artifacts.py`
  - [x] Implement functions for each cleanup category
  - [x] Add dry-run mode for safety
  - [x] Include logging of actions taken
  - [x] Test script thoroughly before committing

- [x] Task 6: Update documentation (AC: 7)
  - [x] Update `tests/README.md` with current directory structure
  - [x] Document test organization standards from testing-strategy.md
  - [x] Add cleanup instructions and schedule
  - [x] Document archive policy

- [ ] Task 7: Run full test suite (AC: 8) **[BLOCKED - Python 3.9 compatibility]**
  - [ ] Execute `pytest tests/unit/` to verify unit tests
  - [ ] Execute `pytest tests/integration/` to verify integration tests
  - [ ] Ensure all 249 tests still pass
  - [ ] Generate coverage report to verify no test files were accidentally removed

## Dev Notes

### Previous Story Context
Story 2.10 (Fix GitHub Tests) was completed and merged via PR #105. The self-hosted runner is now operational on Mac Mini M4, and all tests are passing. This cleanup story builds on that stable foundation.

### Relevant Source Tree Information
[Source: architecture/source-tree.md]
```
tests/
├── integration/      # Integration tests for backend services
├── unit/            # Unit tests for individual backend components
├── fixtures/        # Test data and mock objects (needs cleanup)
├── test_results/    # Old test results from February 2025 (archive)
├── reports/         # Single markdown report from August 2025 (archive)
└── archive/         # Create this for historical data
    ├── coverage/    # Historical coverage reports
    └── reports/     # Historical test reports
```

### Testing Standards
[Source: architecture/testing-strategy.md#file-naming-conventions]
- Unit tests must follow pattern: `test_{module_name}.py`
- Integration tests must follow: `test_{feature}_integration.py`
- Test files should match source file names
- Archive old reports monthly to `tests/archive/`

[Source: architecture/testing-strategy.md#test-organization]
- Test fixtures belong in `tests/fixtures/`
- Shared pytest fixtures go in `conftest.py`
- Coverage reports stored separately from test results

### Coding Standards
[Source: architecture/coding-standards.md#python-backend]
- Use Black for formatting (line length: 88 characters)
- Use Ruff for linting
- All code must pass CI/CD checks before merge

### Files Known to Need Attention
Based on the handoff document, these test-related files need cleanup:
- `scripts/development/test_ai_babysitter.sh` - references non-existent test file
- `scripts/development/view_test_history.sh` - reads broken test results
- `tests/test_results/` - contains outdated JSON files from old project
- `tests/reports/` - single report file to archive

### .gitignore Patterns to Add
```
# Python artifacts
__pycache__/
*.py[cod]
*$py.class
.pytest_cache/
.coverage
.coverage.*
htmlcov/
*.cover
.hypothesis/

# Test artifacts
tests/test_results/*.json
tests/reports/*.md
*.db
*.sqlite
.testmondata
.testmondata.*

# IDE and temp files
.vscode/
.idea/
*.swp
*.swo
*~
.DS_Store
```

### Technical Constraints
- Must maintain compatibility with pytest 7.x
- Coverage requirements: 80% overall, 90% for core modules
- Test execution time: <5 minutes for full suite on self-hosted runner
- All changes must pass GitHub Actions CI workflow

## Testing
[Source: architecture/testing-strategy.md#test-commands]

**Test Execution:**
```bash
# Run all tests
pytest

# Run with coverage
pytest --cov=src --cov-report=html

# Run specific test category
pytest tests/unit/
pytest tests/integration/

# Verify test count (should be 249)
pytest --co -q | wc -l
```

**Test File Locations:**
- Unit tests: `tests/unit/test_*.py`
- Integration tests: `tests/integration/test_*_integration.py`
- Test fixtures: `tests/fixtures/`
- Pytest configuration: `pyproject.toml`

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-27 | 1.0 | Initial story draft created | Scrum Master |
| 2025-08-27 | 1.1 | Completed 6/7 tasks, blocked on Python 3.9 compatibility | James (Dev Agent) |

## Dev Agent Record

### Agent Model Used
Claude Opus 4.1 (claude-opus-4-1-20250805)

### Debug Log References
- Python 3.9 compatibility issues with type hints (union syntax `|` not supported)
- Fixed 56 files converting `X | None` → `Optional[X]` and `list[X]` → `List[X]`
- pytest collection still failing after type hint fixes
- Successfully removed 116 duplicate files with " 2" suffix pattern

### Completion Notes List
- Successfully cleaned 116 duplicate files using custom script
- Created comprehensive cleanup script with dry-run mode and logging
- Archive structure implemented with proper organization
- Python 3.9 compatibility 95% complete - remaining pytest issues need resolution
- All broken test scripts removed (test_ai_babysitter.sh, view_test_history.sh)
- Documentation fully updated with archive policy and cleanup procedures

### File List
**New Files Created:**
- `scripts/cleanup_duplicates.py` - Script to safely remove duplicate files
- `scripts/fix_type_hints.py` - Script to fix Python 3.9 type hint compatibility
- `scripts/maintenance/cleanup_artifacts.py` - Comprehensive maintenance script

**Files Modified:**
- `tests/README.md` - Added directory structure, archive policy, cleanup instructions
- `.gitignore` - Added comprehensive artifact patterns
- `src/**/*.py` - 56 files modified for type hint compatibility (flrts and flrts_bmad modules)

**Files/Directories Removed:**
- 116 duplicate files with " 2" suffix
- `scripts/development/test_ai_babysitter.sh`
- `scripts/development/view_test_history.sh`
- All `__pycache__/` directories (15 total)
- All `.pytest_cache/` directories (1 total)

**Directories Created:**
- `tests/archive/coverage/`
- `tests/archive/reports/`
- `tests/archive/test_results/`

## QA Results

### Review Summary
**Date:** 2025-08-27  
**Reviewer:** Quinn (Senior Developer & QA Architect)  
**Status:** ⚠️ CONDITIONAL PASS - Critical blocker found  
**Quality Score:** 7.5/10  

### Critical Issues Found
1. **P0 - Test Suite Blocked:** Python 3.9 compatibility prevents full test validation
   - 264 tests exist but collection fails due to remaining type hint issues
   - Individual test files pass but full suite cannot run
   - **Risk:** Cannot verify cleanup didn't break functionality

### Validation Results
- ✅ 6/7 Acceptance Criteria Met
- ✅ 116 duplicate files successfully removed
- ✅ Comprehensive cleanup script with safety features
- ✅ Documentation properly updated
- ❌ Test suite validation blocked (AC #8)

### Required for Approval
1. Fix remaining Python 3.9 type hint compatibility issues
2. Successfully run full test suite (264 tests collected, 249+ passing)
3. Maintain coverage ≥80% overall, ≥90% for core modules

### Recommendations
- **Immediate:** Complete Python 3.9 fixes or upgrade minimum to 3.10
- **P1:** Add unit tests for cleanup scripts
- **P2:** Implement cleanup metrics and automation

**Full Quality Gate Report:** `docs/stories/2.1.quality-gate.md`